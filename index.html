<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.2.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script  
    type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    >//this is really cool. James testing git push.</script>
    <style>
      #drop-area {
        width: 350px;
        height: 70px;
        padding: 10px;
        border: 1px solid #aaaaaa;
      }
      .container {
        width: 1000px;
        height: 1000px;
      }
    </style>
  </head>
  <body>
    <p>Drag and drop utility data:</p>

    <div id="drop-area">Drop csv here</div>
    <br />
    <div class="container">
      <div id="chart_consumption"></div> <!--display timeseries consumption (kWh) data-->
    </div>
    <div class="container">
      <div id="chart_demand"></div> <!--display timeseries demand (kW) data-->
    </div>
    <div class="container">
      <div id="chart_scatter"></div> <!--display scatter kW vs air temp data-->
    </div>
    <div class="container">
      <div id="calendar_basic"></div> <!--display calendar view with consumption (kWh) data-->
    </div>
    <div class="container">
      <div id="chart_hourly"></div> <!--display average demand (kW) vs hour of day data-->
    </div>    
    <script>
      csvJson = [];
      function CSVToArray(strData, strDelimiter) {
        // Check to see if the delimiter is defined. If not,
        // then default to comma.
        strDelimiter = strDelimiter || ",";
        // Create a regular expression to parse the CSV values.
        var objPattern = new RegExp(
          // Delimiters.
          "(\\" +
            strDelimiter +
            "|\\r?\\n|\\r|^)" +
            // Quoted fields.
            '(?:"([^"]*(?:""[^"]*)*)"|' +
            // Standard fields.
            '([^"\\' +
            strDelimiter +
            "\\r\\n]*))",
          "gi"
        );
        // Create an array to hold our data. Give the array
        // a default empty first row.
        var arrData = [[]];
        // Create an array to hold our individual pattern
        // matching groups.
        var arrMatches = null;
        // Keep looping over the regular expression matches
        // until we can no longer find a match.
        while ((arrMatches = objPattern.exec(strData))) {
          // Get the delimiter that was found.
          var strMatchedDelimiter = arrMatches[1];
          // Check to see if the given delimiter has a length
          // (is not the start of string) and if it matches
          // field delimiter. If id does not, then we know
          // that this delimiter is a row delimiter.
          if (
            strMatchedDelimiter.length &&
            strMatchedDelimiter != strDelimiter
          ) {
            // Since we have reached a new row of data,
            // add an empty row to our data array.
            arrData.push([]);
          }
          // Now that we have our delimiter out of the way,
          // let's check to see which kind of value we
          // captured (quoted or unquoted).
          if (arrMatches[2]) {
            // We found a quoted value. When we capture
            // this value, unescape any double quotes.
            var strMatchedValue = arrMatches[2].replace(
              new RegExp('""', "g"),
              '"'
            );
          } else {
            // We found a non-quoted value.
            var strMatchedValue = arrMatches[3];
          }
          // Now that we have our value string, let's add
          // it to the data array.
          arrData[arrData.length - 1].push(strMatchedValue);
        }
        // Return the parsed data.
        return arrData;
      }

      function CSV2JSON(csv) {
        var array = CSVToArray(csv);
        var objArray = [];
        for (var i = 1; i < array.length; i++) {
          objArray[i - 1] = {};
          for (var k = 0; k < array[0].length && k < array[i].length; k++) {
            var key = array[0][k];
            objArray[i - 1][key] = array[i][k];
          }
        }

        var json = JSON.stringify(objArray);
        var str = json.replace(/},/g, "},\r\n");

        return str;
      }
      function handleOther(e) {
        e.preventDefault();
      }
      async function handleDrop(e) {
        e.preventDefault();
        let dt = e.dataTransfer;
        let files = dt.files;

        const csv = await files[0].text();
        const json = CSV2JSON(csv);
        console.log(json);
        csvJson = json;
      }
      let dropArea = document.getElementById("drop-area");

      dropArea.addEventListener("dragenter", handleOther, false);
      dropArea.addEventListener("dragleave", handleOther, false);
      dropArea.addEventListener("dragover", handleOther, false);
      dropArea.addEventListener("drop", handleDrop, false);
    </script>
    <!-- end of drag-and-drop javascript -->

    <!-- chart javascript -->
    <script>
      google.charts.load("current", { packages: ["calendar", "corechart", "line"] });
      google.charts.setOnLoadCallback(drawAllCharts);

      function drawAllCharts() {
        // line chart
        const lineRows = [];
        const scatterRows = [];
        const calendarRows = [];
        const barRows = [];
        let previousDate;
        for (let i = 0; i < csvJson.length; i++) {
          const record = csvJson[i];
          const date = record["End Date Time"];
          const usage = parseInt(record["Usage"]);

          // create line chart data
          lineRows.push([date, usage]);

          // create scatter chart data

          // create calendar chart data
          if (moment(previousDate, 'MM/DD/YY H:mm').isSame(moment(date, 'MM/DD/YY H:mm'), 'day')) {
            calendarRows[calendarRows.length - 1][1] += (usage || 0);
          } else {
            previousDate = date;
            calendarRows.push([moment(date, 'MM/DD/YY H:mm').toDate(), usage || 0]);
          }

          // create bar chart data
        }

        // build calendar chart
        var calendarData = new google.visualization.DataTable();
        calendarData.addColumn({ type: 'date', id: 'Date' });
        calendarData.addColumn({ type: 'number', id: 'Daily Usage' });
        calendarData.addRows(calendarRows);

        var calendarChart = new google.visualization.Calendar(document.getElementById('calendar_basic'));

        var calendarOptions = {
          title: "Energy Consumption",
          height: 350,
        };

        calendarChart.draw(calendarData, calendarOptions);

        // build line chart
        var lineData = new google.visualization.DataTable();
        lineData.addColumn("string", "Date");
        lineData.addColumn("number", "Usage");

        lineData.addRows(lineRows);

        var lineOptions = {
          hAxis: {
            title: "Date",
          },
          vAxis: {
            title: "Average Usage (kWh)",
          },
          explorer: {
            dragToPan: {
              axis: "horizontal",
            },
          },
        };

        var lineChart = new google.visualization.LineChart(
          document.getElementById("chart_demand")
        );

        lineChart.draw(lineData, lineOptions);
      }
    </script>
  </body>
</html>