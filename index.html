<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.2.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script  
    type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
    <style>
      #drop-area {
        width: 350px;
        height: 70px;
        padding: 10px;
        border: 1px solid blue;
      }
      .container {
        width: 1000px;
        height: 300px;
      }
    </style>
  </head>
  <body>
    <p>Drag your utility data into the area below:</p>

    <div id="drop-area">Drop csv file here</div>
    <br />
    <div class="container">
      <div id="chart_consumption"></div> <!--display timeseries consumption (kWh) data-->
    </div>
    <div class="container">
      <div id="chart_demand"></div> <!--display timeseries demand (kW) data-->
    </div>
    <div class="container">
      <div id="chart_scatter"></div> <!--display scatter kW vs air temp data-->
    </div>
    <div class="container">
      <div id="calendar_basic"></div> <!--display calendar view with consumption (kWh) data-->
    </div>
    <div class="container">
      <div id="chart_hourly"></div> <!--display average demand (kW) vs hour of day data. x axis will have 1 - 24 hours-->
    </div>    
    <script>
      CSV_JSON = [];
      function CSVToArray(strData, strDelimiter) {
        // Check to see if the delimiter is defined. If not,
        // then default to comma.
        strDelimiter = strDelimiter || ",";
        // Create a regular expression to parse the CSV values.
        var objPattern = new RegExp(
          // Delimiters.
          "(\\" +
            strDelimiter +
            "|\\r?\\n|\\r|^)" +
            // Quoted fields.
            '(?:"([^"]*(?:""[^"]*)*)"|' +
            // Standard fields.
            '([^"\\' +
            strDelimiter +
            "\\r\\n]*))",
          "gi"
        );
        // Create an array to hold our data. Give the array
        // a default empty first row.
        var arrData = [[]];
        // Create an array to hold our individual pattern
        // matching groups.
        var arrMatches = null;
        // Keep looping over the regular expression matches
        // until we can no longer find a match.
        while ((arrMatches = objPattern.exec(strData))) {
          // Get the delimiter that was found.
          var strMatchedDelimiter = arrMatches[1];
          // Check to see if the given delimiter has a length
          // (is not the start of string) and if it matches
          // field delimiter. If id does not, then we know
          // that this delimiter is a row delimiter.
          if (
            strMatchedDelimiter.length &&
            strMatchedDelimiter != strDelimiter
          ) {
            // Since we have reached a new row of data,
            // add an empty row to our data array.
            arrData.push([]);
          }
          // Now that we have our delimiter out of the way,
          // let's check to see which kind of value we
          // captured (quoted or unquoted).
          if (arrMatches[2]) {
            // We found a quoted value. When we capture
            // this value, unescape any double quotes.
            var strMatchedValue = arrMatches[2].replace(
              new RegExp('""', "g"),
              '"'
            );
          } else {
            // We found a non-quoted value.
            var strMatchedValue = arrMatches[3];
          }
          // Now that we have our value string, let's add
          // it to the data array.
          arrData[arrData.length - 1].push(strMatchedValue);
        }
        // Return the parsed data.
        return arrData;
      }

      function CSV2JSON(csv) {
        var array = CSVToArray(csv);
        var objArray = [];
        for (var i = 1; i < array.length; i++) {
          objArray[i - 1] = {};
          for (var k = 0; k < array[0].length && k < array[i].length; k++) {
            var key = array[0][k];
            objArray[i - 1][key] = array[i][k];
          }
        }

        var json = JSON.stringify(objArray);
        var str = json.replace(/},/g, "},\r\n");

        return JSON.parse(str);
      }
      function handleOther(e) {
        e.preventDefault();
      }
      async function handleDrop(e) {
        e.preventDefault();
        let dt = e.dataTransfer;
        let files = dt.files;

        const csv = await files[0].text();
        CSV_JSON = CSV2JSON(csv);
        loadCharts();
      }
      let dropArea = document.getElementById("drop-area");

      dropArea.addEventListener("dragenter", handleOther, false);
      dropArea.addEventListener("dragleave", handleOther, false);
      dropArea.addEventListener("dragover", handleOther, false);
      dropArea.addEventListener("drop", handleDrop, false);
    </script>
    <!-- end of drag-and-drop javascript -->

    <!-- chart javascript -->
    <script>
      function loadCharts() {
        google.charts.load("current", { packages: ["calendar", "corechart", "line", "bar"] });
        google.charts.setOnLoadCallback(drawAllCharts);
      }

      function drawAllCharts() {
        // line chart
        const lineRows = [];
        const lineDemandRows = [];
        const scatterRows = [];
        const calendarRows = [];
        const barRows = [];
        let previousDate;
        let previousHour;
        for (let i = 0; i < CSV_JSON.length - 1; i++) {
          const record = CSV_JSON[i];
          const date = record["End Date Time"];
          const usage = parseInt(record["Usage"]);
          const temp = parseInt(record["Avg. Temperature"]);
          const demand = parseInt(record["Peak Demand"]);
          //const AvgDemand = Would like to calculate (AvgDemand = Usage/4) this and put it on the "line demand chart with peak demand in two series"

          // create line chart data
          lineRows.push([date, usage]);
          
          // create line demand chart data
          lineDemandRows.push([date, demand]);

          // create scatter chart data
          scatterRows.push([temp, usage]);          

          // create calendar chart data
          if (moment(previousDate, 'MM/DD/YY H:mm').isSame(moment(date, 'MM/DD/YY H:mm'), 'day')) { //if same day, then sum usage
            calendarRows[calendarRows.length - 1][1] += (usage || 0);
          } else {
            previousDate = date;
            calendarRows.push([moment(date, 'MM/DD/YY H:mm').toDate(), usage || 0]);
          }

          // create bar chart data
          if (moment(previousHour, 'MM/DD/YY H:mm').isSame(moment(date, 'MM/DD/YY H:mm'), 'hour')) { //if same hour, then sum usage
            barRows[calendarRows.length - 1][1] += (usage || 0);
          } else {
            previousHour = date;
            barRows.push([moment(date, 'MM/DD/YY H:mm').toDate(), usage || 0]);
          }

          
          //TODO: insert function here to 1. SUM data by the hour 2. AVERAGE all usage IF the hours are the same. 
            //TODO: Add feature - drop down to select ALL data or by month
        }

        // build line demand chart
        var lineDemandData = new google.visualization.DataTable();
        lineDemandData.addColumn("string", "Date");
        lineDemandData.addColumn("number", "Demand");

        lineDemandData.addRows(lineDemandRows);

        var lineDemandOptions = {
          hAxis: {
            title: "Date",
          },
          vAxis: {
            title: "Peak Demand (kW)",
          },
          explorer: {
            dragToPan: {
              axis: "horizontal",
            },
          },
        };

        var lineDemandChart = new google.visualization.LineChart(
          document.getElementById("chart_demand")
        );

        lineDemandChart.draw(lineDemandData, lineDemandOptions);

        // build scatter chart
        var scatterData = new google.visualization.DataTable();
        scatterData.addColumn("number", "Temp");
        scatterData.addColumn("number", "Demand");

        scatterData.addRows(scatterRows);

        var scatterOptions = {
          title: '',
          hAxis: {title: 'Outdoor air Temperature (F)', minValue: 0, maxValue: 100},
          vAxis: {title: 'Power (kW)', minValue: 0, maxValue: 500},
          legend: 'none',
          dataOpacity: 0.3,
          explorer: {
            dragToPan: {
              axis: "horizontal",
            },
          },
        };

        var scatterChart = new google.visualization.ScatterChart(document.getElementById('chart_scatter'));

        scatterChart.draw(scatterData, scatterOptions);

        // build calendar chart
        var calendarData = new google.visualization.DataTable();
        calendarData.addColumn({ type: 'date', id: 'Date' });
        calendarData.addColumn({ type: 'number', id: 'Daily Usage' });
          //console.log("calendarRows",calendarRows);
        calendarData.addRows(calendarRows);

        var calendarChart = new google.visualization.Calendar(document.getElementById('calendar_basic'));

        var calendarOptions = {
          title: "Energy Consumption",
          height: 350,
        };

        calendarChart.draw(calendarData, calendarOptions);

        // build line chart
        var lineData = new google.visualization.DataTable();
        lineData.addColumn("string", "Date");
        lineData.addColumn("number", "Usage");

        lineData.addRows(lineRows);

        var lineOptions = {
          hAxis: {
            title: "Date",
          },
          vAxis: {
            title: "Usage (kWh)",
          },
          explorer: {
            dragToPan: {
              axis: "horizontal",
            },
          },
        };

        var lineChart = new google.visualization.LineChart(
          document.getElementById("chart_consumption")
        );

        lineChart.draw(lineData, lineOptions);

        //build bar chart       
        var barData = new google.visualization.DataTable();
        barData.addColumn("number", "Hour");
        barData.addColumn("number", "Usage");        
        console.log('hours',barRows);         
        barData.addRows(barRows);        
         

        /*
        var barData = google.visualization.arrayToDataTable([
          ['Hour', 'Consumption'],
          ['1', 50],
          ['2', 50],
          ['3', 300],
          ['4', 500],
          ['5', 500],
          ['6', 300],
          ['7', 50],
          ['8', 50]         
        ]);//Think we can change the data format of this to match the other charts. This should be 1 to 24 hours rather than the example 1 to 8.
*/

        var barOptions = {
          chart: {
            title: 'Average consumption over 24 hours',
            subtitle: ''
          },
          axes: {
            x: {
              0: {side: 'bottom'}
            }
          },
          hAxis: {
            title: 'Time of Day',
            format: 'h:mm a',
            viewWindow: {
              min: [7, 30, 0],
              max: [17, 30, 0]
            }
          },
          vAxis: {
            title: ''
          }
        };

        var barChart = new google.charts.Bar(document.getElementById('chart_hourly'));
        barChart.draw(barData, barOptions);
      }
    </script>
  </body>
</html>