<!DOCTYPE html>
<html>
  <head>

    <script src="./FullSample.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/@chartshq/muze@2.0.0/dist/muze.css"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/@chartshq/muze@2.0.0/dist/muze.js"
      type="text/javascript"
    ></script>
    <style>
      #chart {
        width: 800px;
        height: 550px;
      }
    </style>
  </head>
  <body>
    <h1 style="text-align: center">Upload sample set here</h1>

    <p style="text-align: center">
      <button id="btnSubmit1" type="submit" onclick="sampleOffice()">
        Sample Office Data
      </button>
    </p>
    <p style="text-align: center">
      <button id="btnSubmit2" type="submit" onclick="sampleLab()">
        Sample Lab Data
      </button>
    </p>

    <!-- displays value of Sample Office Data -->
    <p id="sampleOfficeDemo" style="text-align: center; display: none">
      Sample Office Data selected
    </p>
    <p id="sampleLabDemo" style="text-align: center; display: none">
      Sample Lab Data selected
    </p>

    <h1 style="text-align: center">
      Drag the utility data into the area below:
    </h1>
    <div
      style="
        text-align: center;
        width: 300px;
        height: 150px;
        padding: 10px;
        border: 3px solid gray;
        border-style: dashed;
        cursor: cell;
        margin: 0 auto;
      "
      id="drop-area"
    >
      Drop csv file here <br /><span style="font-size: 50px">üìÅ</span>
    </div>
    <div id="chart"></div>
    <script>
      //CSV_JSON = []; //Have this base file load from http link
      CSV_JSON = [];

      // When button click run fuction to populate
      function sampleOffice() {
        var text = document.getElementById("sampleOfficeDemo");
        //CSV_JSON = []; //TODO: have this pull from link
        //getFile = 'https://media.githubusercontent.com/media/JamesDevJim/james-energy-charts/master/FullSample.csv'
        //CSV_JSON =  getFile
        //loadCharts();
        // Statement to display Sample Data Loaded
        if (text.style.display === "none") {
          text.style.display = "block";
          document.getElementById("sampleLabDemo").style.display = "none";
        }
      }

      function sampleLab() {
        var text = document.getElementById("sampleLabDemo");
        //CSV_JSON = []; //TODO: have this pull from link
        //loadCharts();
        // Statement to display Sample Data Loaded
        if (text.style.display === "none") {
          text.style.display = "block";
          document.getElementById("sampleOfficeDemo").style.display = "none";
        }
      }

      // Bunch of CSV to array stuff that Sean put in this code.
      function CSVToArray(strData, strDelimiter) {
        // Check to see if the delimiter is defined. If not,
        // then default to comma.
        strDelimiter = strDelimiter || ",";
        // Create a regular expression to parse the CSV values.
        var objPattern = new RegExp(
          // Delimiters.
          "(\\" +
            strDelimiter +
            "|\\r?\\n|\\r|^)" +
            // Quoted fields.
            '(?:"([^"]*(?:""[^"]*)*)"|' +
            // Standard fields.
            '([^"\\' +
            strDelimiter +
            "\\r\\n]*))",
          "gi"
        );
        // Create an array to hold our data. Give the array
        // a default empty first row.
        var arrData = [[]];
        // Create an array to hold our individual pattern
        // matching groups.
        var arrMatches = null;
        // Keep looping over the regular expression matches
        // until we can no longer find a match.
        while ((arrMatches = objPattern.exec(strData))) {
          // Get the delimiter that was found.
          var strMatchedDelimiter = arrMatches[1];
          // Check to see if the given delimiter has a length
          // (is not the start of string) and if it matches
          // field delimiter. If id does not, then we know
          // that this delimiter is a row delimiter.
          if (
            strMatchedDelimiter.length &&
            strMatchedDelimiter != strDelimiter
          ) {
            // Since we have reached a new row of data,
            // add an empty row to our data array.
            arrData.push([]);
          }
          // Now that we have our delimiter out of the way,
          // let's check to see which kind of value we
          // captured (quoted or unquoted).
          if (arrMatches[2]) {
            // We found a quoted value. When we capture
            // this value, unescape any double quotes.
            var strMatchedValue = arrMatches[2].replace(
              new RegExp('""', "g"),
              '"'
            );
          } else {
            // We found a non-quoted value.
            var strMatchedValue = arrMatches[3];
          }
          // Now that we have our value string, let's add
          // it to the data array.
          arrData[arrData.length - 1].push(strMatchedValue);
        }
        // Return the parsed data.
        return arrData;
      }

      function CSV2JSON(csv) {
        var array = CSVToArray(csv);
        var objArray = [];
        for (var i = 1; i < array.length; i++) {
          objArray[i - 1] = {};
          for (var k = 0; k < array[0].length && k < array[i].length; k++) {
            var key = array[0][k];
            objArray[i - 1][key] = array[i][k];
          }
        }
        var json = JSON.stringify(objArray);
        var str = json.replace(/},/g, "},\r\n");
        return JSON.parse(str);
      }
      function handleOther(e) {
        e.preventDefault();
      }
      async function handleDrop(e) {
        e.preventDefault();
        let dt = e.dataTransfer;
        let files = dt.files;
        const csv = await files[0].text();
        //console.log('csv', csv);
        CSV_JSON = CSV2JSON(csv);
        //console.log('CSVdata', CSV_JSON);
        loadCharts();
      }
      let dropArea = document.getElementById("drop-area");
      dropArea.addEventListener("dragenter", handleOther, false);
      dropArea.addEventListener("dragleave", handleOther, false);
      dropArea.addEventListener("dragover", handleOther, false);
      dropArea.addEventListener("drop", handleDrop, false);
    </script>
    <!-- end of drag-and-drop javascript -->

    <!-- chart javascript -->
    <script>
      async function loadCharts() {
        // Load the DataModel module.
        const DataModel = await muze.DataModel.onReady();
        const json = CSV2JSON(csv);
        console.log(json);
        // Date":"1986-03-13","Open":"0.088542","High":"0.101563","Low":"0.088542","Close":"0.097222","Adj Close":"0.062549","Volume":"1031788800"},{"Date":"1986-03-14","Open":"0.097222","High":"0.102431","Low":"0.097222","Close":"0.100694","Adj Close":"0.064783","Volume":"308160000"},{"Date":"1986-03-17","Open":"0.100694","High":"0.103299","Low":"0.100694","Close":"0.102431","Adj Close":"0.065899","Volume":"133171200"},{"Date":"1986-03-18","Open":"0.102431","High":"0.103299","Low":"0.098958","Close":"0.099826","Adj Close":"0.064224","Volume":"67766400"},{"Date":"1986-03-19","Open":"0.099826","High":"0.100694","Low":"0.097222","Close":"0.098090","Adj Close":"0.063107","Volume":"47894400"},{"Date":"1986-03-20","Open":"0.098090","High":"0.098090","Low":"0.094618","Close":"0.095486","Adj Close":"0.061432","Volume":"58435200"},{"Date":"1986-03-21","Open":"0.095486","High":"0.097222","Low":"0.091146","Close":
        // const data = json.map(d => ({
        //   'Date': d.
        // }));
        const schema = [
          {
            name: "Start Date Time",
            type: "dimension",
            subtype: "temporal",
            format: "%m/%d/%Y %H:%M", // "7/18/2020 4:00"
          },
          {
            name: "Usage",
            type: "measure",
          },
        ];

        const formattedData = await DataModel.loadData(json, schema);
        const dm = new DataModel(formattedData);

        const env = await muze();

        env
          .canvas()
          .data(dm)
          .rows(["Usage"])
          .columns(["Start Date Time"]) // Year goes in x-axis
          .title("Usage Calendar Chart", { position: "top", align: "center" })
          .subtitle("1986 - 2020", { position: "top", align: "center" })
          .config({
            border: {
              // Hide the layout borders for better visibility
              showValueBorders: {
                left: false,
                bottom: false,
              },
            },
          })
          .mount("#chart");
      }
      loadCharts();
    </script>
  </body>
</html>
